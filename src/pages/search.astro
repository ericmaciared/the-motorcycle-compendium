---
import BaseLayout from '../layouts/BaseLayout.astro';
import BikeCard from '../components/BikeCard.astro';
import { supabase } from '../lib/supabase';

const url = new URL(Astro.request.url);
const searchQuery = url.searchParams.get('q') || '';

type BikeSearchResult = {
  id: string;
  slug: string;
  variant_name: string;
  year: number;
  price_usd: number | null;
  engine_displacement_cc: number | null;
  horsepower_hp: number | null;
  description: string | null;
  model_name: string;
  manufacturer_name: string;
  category: string | null;
};

let motorcycles: BikeSearchResult[] = [];

if (searchQuery.trim()) {
  // Search across multiple fields including manufacturer name
  const { data: bikes, error: searchError } = await supabase
    .from('motorbike_variants')
    .select(`
      *,
      motorbike_models!inner (
        name,
        category,
        manufacturers!inner (
          name
        )
      )
    `)
    .or(`variant_name.ilike.%${searchQuery}%,description.ilike.%${searchQuery}%,motorbike_models.name.ilike.%${searchQuery}%,motorbike_models.manufacturers.name.ilike.%${searchQuery}%`)
    .order('created_at', { ascending: false });

  if (searchError) {
    console.error('Error searching bikes:', searchError);
  }

  // Transform data
  motorcycles = bikes?.map(bike => ({
    id: bike.id,
    slug: bike.slug,
    variant_name: bike.variant_name,
    year: bike.year,
    price_usd: bike.price_usd,
    engine_displacement_cc: bike.engine_displacement_cc,
    horsepower_hp: bike.horsepower_hp,
    description: bike.description,
    model_name: bike.motorbike_models.name,
    manufacturer_name: bike.motorbike_models.manufacturers.name,
    category: bike.motorbike_models.category,
  })) || [];
}
---

<BaseLayout title={`Search: ${searchQuery} - The Motorbike Compendium`}>
  <div class="container mx-auto px-4 py-8">
    <!-- Search Header -->
    <div class="mb-8">
      <h1 class="text-4xl font-bold mb-4">Search Results</h1>
      
      <!-- Search Bar -->
      <div class="max-w-2xl">
        <form method="get" action="/search">
          <div class="relative">
            <input
              type="text"
              name="q"
              value={searchQuery}
              placeholder="Search by make, model, or type..."
              class="w-full px-6 py-4 pr-12 rounded-lg border-2 border-slate-300 text-slate-900 text-lg focus:outline-none focus:ring-4 focus:ring-blue-500 focus:border-blue-500"
              autofocus
            />
            <button
              type="submit"
              class="absolute right-2 top-1/2 -translate-y-1/2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition"
            >
              üîç Search
            </button>
          </div>
        </form>
      </div>

      {searchQuery && (
        <p class="text-slate-600 mt-4">
          {motorcycles.length > 0 ? (
            <>
              Found <span class="font-semibold">{motorcycles.length}</span> {motorcycles.length === 1 ? 'result' : 'results'} for "{searchQuery}"
            </>
          ) : (
            <>No results found for "{searchQuery}"</>
          )}
        </p>
      )}
    </div>

    <!-- Results -->
    {!searchQuery ? (
      <div class="bg-slate-50 rounded-lg p-12 text-center">
        <div class="text-6xl mb-4">üîç</div>
        <h2 class="text-2xl font-bold mb-2">Start Your Search</h2>
        <p class="text-slate-600">Enter a motorcycle make, model, or keyword above</p>
      </div>
    ) : motorcycles.length > 0 ? (
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
        {motorcycles.map(bike => (
          <BikeCard bike={bike} />
        ))}
      </div>
    ) : (
      <div class="bg-white rounded-lg shadow-md p-12 text-center">
        <div class="text-6xl mb-4">üòû</div>
        <h2 class="text-2xl font-bold mb-2">No Results Found</h2>
        <p class="text-slate-600 mb-6">
          We couldn't find any motorcycles matching "{searchQuery}"
        </p>
        <div class="space-y-4">
          <p class="text-sm text-slate-500">Try:</p>
          <ul class="text-sm text-slate-600 space-y-2">
            <li>‚Ä¢ Checking your spelling</li>
            <li>‚Ä¢ Using different keywords</li>
            <li>‚Ä¢ Searching by manufacturer (Honda, Yamaha, etc.)</li>
            <li>‚Ä¢ Searching by category (Sport, Adventure, etc.)</li>
          </ul>
          <a
            href="/bikes"
            class="inline-block bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 transition mt-4"
          >
            Browse All Motorcycles
          </a>
        </div>
      </div>
    )}

    <!-- Popular Searches -->
    {!searchQuery && (
      <div class="mt-12">
        <h2 class="text-2xl font-bold mb-4">Popular Searches</h2>
        <div class="flex flex-wrap gap-3">
          <a href="/search?q=sport" class="bg-slate-100 hover:bg-slate-200 px-4 py-2 rounded-full text-sm font-semibold transition">
            Sport Bikes
          </a>
          <a href="/search?q=Honda" class="bg-slate-100 hover:bg-slate-200 px-4 py-2 rounded-full text-sm font-semibold transition">
            Honda
          </a>
          <a href="/search?q=Ducati" class="bg-slate-100 hover:bg-slate-200 px-4 py-2 rounded-full text-sm font-semibold transition">
            Ducati
          </a>
          <a href="/search?q=adventure" class="bg-slate-100 hover:bg-slate-200 px-4 py-2 rounded-full text-sm font-semibold transition">
            Adventure Bikes
          </a>
          <a href="/search?q=1000cc" class="bg-slate-100 hover:bg-slate-200 px-4 py-2 rounded-full text-sm font-semibold transition">
            1000cc
          </a>
        </div>
      </div>
    )}
  </div>
</BaseLayout>