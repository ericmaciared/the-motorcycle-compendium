---
import BaseLayout from '../../layouts/BaseLayout.astro';
import BikeCard from '../../components/BikeCard.astro';
import { supabase } from '../../lib/supabase';
import type { Manufacturer, MotorbikeModel, MotorbikeVariant } from '../../lib/supabase';

export async function getStaticPaths() {
  const { data: manufacturers } = await supabase
    .from('manufacturers')
    .select('slug');

  return manufacturers?.map((manufacturer) => ({
    params: { name: manufacturer.slug },
  })) || [];
}

const { name } = Astro.params;

if (!name) {
  return Astro.redirect('/404');
}

// Convert URL slug back to manufacturer name format
const manufacturerSlug = name.toLowerCase();

// Fetch manufacturer details
const { data: manufacturer, error: manufacturerError } = await supabase
  .from('manufacturers')
  .select('*')
  .eq('slug', manufacturerSlug)
  .single();

if (manufacturerError || !manufacturer) {
  console.error('Error fetching manufacturer:', manufacturerError);
  return Astro.redirect('/404');
}

// Fetch all models for this manufacturer with their variants
const { data: models, error: modelsError } = await supabase
  .from('motorbike_models')
  .select('*')
  .eq('manufacturer_id', manufacturer.id);

if (modelsError) {
  console.error('Error fetching models:', modelsError);
}

// Fetch all variants for these models
const modelIds = models?.map(m => m.id) || [];
const { data: variants, error: variantsError } = await supabase
  .from('motorbike_variants')
  .select('*, motorbike_models!inner(*, manufacturers!inner(*))')
  .in('model_id', modelIds)
  .eq('is_available', true)
  .order('year', { ascending: false });

if (variantsError) {
  console.error('Error fetching variants:', variantsError);
}

// Transform data to match BikeCard interface
const bikes = variants?.map(bike => ({
  id: bike.id,
  slug: bike.slug,
  variant_name: bike.variant_name,
  year: bike.year,
  price_usd: bike.price_usd,
  engine_displacement_cc: bike.engine_displacement_cc,
  horsepower_hp: bike.horsepower_hp,
  description: bike.description,
  model_name: bike.motorbike_models.name,
  manufacturer_name: bike.motorbike_models.manufacturers.name,
  category: bike.motorbike_models.category,
})) || [];
---

<BaseLayout title={`${manufacturer.name} Motorcycles | The Motorbike Compendium`}>
  <div class="container mx-auto px-4 py-12">
    <!-- Breadcrumb -->
    <nav class="mb-8 text-xs text-topo-700 uppercase tracking-wider">
      <a href="/" class="hover:text-signal-blue font-medium">Home</a>
      <span class="mx-2">/</span>
      <a href="/bikes" class="hover:text-signal-blue font-medium">Bikes</a>
      <span class="mx-2">/</span>
      <span class="text-topo-900 font-bold">{manufacturer.name}</span>
    </nav>

    <!-- Manufacturer Header -->
    <div class="bg-topo-50 elevation-2 p-8 mb-12 relative">
      <!-- Subtle background pattern -->
      <div class="absolute inset-0 bg-flow-field opacity-10 pointer-events-none"></div>

      <div class="flex flex-col lg:flex-row items-start justify-between gap-6 relative">
        <div class="flex-1">
          <div class="flex items-center gap-2 mb-3">
            <span class="signal-dot bg-signal-amber"></span>
            <span class="text-xs font-bold text-topo-700 uppercase tracking-widest">Manufacturer</span>
          </div>
          <h1 class="text-5xl font-bold text-topo-900 mb-4 tracking-tight">{manufacturer.name}</h1>

          <div class="flex flex-wrap gap-6 mb-6">
            {manufacturer.country && (
              <div>
                <span class="text-xs text-topo-700 uppercase tracking-wider font-bold block mb-1">Country</span>
                <p class="text-topo-900 font-bold">{manufacturer.country}</p>
              </div>
            )}
            {manufacturer.founded_year && (
              <div>
                <span class="text-xs text-topo-700 uppercase tracking-wider font-bold block mb-1">Founded</span>
                <p class="text-topo-900 font-bold metric-value">{manufacturer.founded_year}</p>
              </div>
            )}
          </div>

          {manufacturer.description && (
            <p class="text-topo-900 leading-relaxed max-w-3xl">
              {manufacturer.description}
            </p>
          )}
        </div>

        {manufacturer.website_url && (
          <a
            href={manufacturer.website_url}
            target="_blank"
            rel="noopener noreferrer"
            class="bg-topo-900 text-topo-50 px-6 py-3 font-bold hover:bg-signal-blue transition whitespace-nowrap uppercase tracking-wider text-sm elevation-1"
          >
            Visit Website ‚Üí
          </a>
        )}
      </div>
    </div>

    <!-- Models Count -->
    <div class="mb-10">
      <h2 class="text-3xl font-bold text-topo-900 mb-2 tracking-tight">
        Available Models
      </h2>
      <div class="flex items-center gap-3">
        <span class="data-point bg-signal-blue"></span>
        <p class="text-topo-700 uppercase tracking-wider text-sm font-bold">
          {bikes.length} {manufacturer.name} motorcycles in collection
        </p>
      </div>
    </div>

    <!-- Bikes Grid -->
    {bikes.length > 0 ? (
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {bikes.map((bike) => (
          <BikeCard bike={bike} />
        ))}
      </div>
    ) : (
      <div class="bg-topo-50 elevation-2 p-12 text-center">
        <span class="text-6xl mb-4 block">üèçÔ∏è</span>
        <h3 class="text-xl font-bold text-topo-900 mb-2">
          No Models Available
        </h3>
        <p class="text-topo-800 mb-6">
          We currently don't have any {manufacturer.name} motorcycles in our database.
        </p>
        <a
          href="/bikes"
          class="inline-block bg-topo-900 text-topo-50 px-6 py-3 font-bold hover:bg-signal-blue transition uppercase tracking-wider text-sm elevation-1"
        >
          Browse All Bikes
        </a>
      </div>
    )}
  </div>
</BaseLayout>
